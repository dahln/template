@page "/folder/{FolderId}/customer"
@page "/folder/{FolderId}/customer/{id}"

@using ghostlight.Shared.Enumerations
@using Newtonsoft.Json;

@inject NavigationManager _navigationManager
@inject ghostlight.Client.Services.API API
@inject ghostlight.Client.Services.AppState _appState
@inject IModalService _modalService
@inject IToastService _toastService
@inject SpinnerService _spinnerService
@inject IJSRuntime JSRuntime

<div class="mb-3">
    <NavLink href="@($"folder/{FolderId}/customers")">
        &#171; Back to Search
    </NavLink>
</div>

<div class="row">
    <div class="col-md-12">
        <h3>
            Customer
            @if (Locked == true && (_appState.AuthorizedFolders.FirstOrDefault(f => f.Id == _appState.CurrentFolderId)?.Write == true || _appState.AuthorizedFolders.FirstOrDefault(f => f.Id == _appState.CurrentFolderId)?.Delete == true))
            {
                <span class="btn btn-link" @onclick="ToggleEditing">Edit</span>
            }
        </h3>
    </div>
</div>

<fieldset disabled="@Locked">
    <div class="row">
        <div class="col-md-6">
            <div class="row">
                <div class="col-md-6 text-center">
                    <div class="row">
                        <div class="col-md-12">
                            @if (string.IsNullOrEmpty(customer.ImageBase64))
                            {
                                <i class="far fa-image fa-7x business-logo-placeholder mt-md-5 mb-2"></i>
                            }
                            else
                            {
                                <img src="@customer.ImageBase64" class="mb-2 profile-image" />
                            }
                        </div>
                    </div>
                    @if (!Locked && _appState.AuthorizedFolders.FirstOrDefault(f => f.Id == _appState.CurrentFolderId)?.Write == true)
                    {
                        <div class="row">
                            <div class="col-md-12">
                                <label class="btn btn-outline-primary w-100">
                                    <InputFile OnChange="OnInputFileChange" style="display:none;" accept="image/*" />Upload File (32mb size limit)
                                </label>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(customer.ImageBase64))
                        {
                            <div class="row">
                                <div class="col-md-12">
                                    <input type="button" value="Remove Image" class="btn btn-outline-danger w-100" @onclick="RemoveFile" />
                                </div>
                            </div>
                        }
                    }
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-12">
                            <label>Name</label>
                            <input type="text" class="form-control" @bind="customer.Name" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="row">
                <div class="col-md-6">
                    <label>Email</label>
                    <input type="text" class="form-control" @bind="customer.Email" />
                </div>
                <div class="col-md-6">
                    <label>Phone</label>
                    <input type="text" class="form-control" @bind="customer.Phone" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <label>Address</label>
                    <input type="text" class="form-control" @bind="customer.Address" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <label>City</label>
                    <input type="text" class="form-control" @bind="customer.City" />
                </div>
                <div class="col-md-4">
                    <label>State</label>
                    <input type="text" class="form-control" @bind="customer.State" />
                </div>
                <div class="col-md-4">
                    <label>Postal</label>
                    <input type="text" class="form-control" @bind="customer.Postal" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <label>Notes</label>
                    <textarea class="form-control" rows="7" @bind="customer.Notes"></textarea>
                </div>
            </div>
        </div>
    </div>

</fieldset>

<div class="row">
    <div class="col-md-12">
        <hr />
    </div>
</div>

@if (Locked == false)
{
    <div class="row">
        <div class="col-md-6">
            @if (!string.IsNullOrEmpty(Id) && _appState.AuthorizedFolders.FirstOrDefault(f => f.Id == _appState.CurrentFolderId)?.Delete == true)
            {
                <button class="btn btn-warning btn-customer" @onclick="Delete"><i class="far fa-trash-alt mr-1"></i>Delete</button>
            }
        </div>

        <div class="col-md-6">
            @if (_appState.AuthorizedFolders.FirstOrDefault(f => f.Id == _appState.CurrentFolderId)?.Write == true)

            {
                <button class="btn btn-primary btn-customer float-right" @onclick="Save"><i class="far fa-save mr-1"></i>Save</button>
                @if (!string.IsNullOrEmpty(Id))
                {
                    <button class="btn btn-outline-dark btn-customer float-right mr-lg-2 mr-md-2" @onclick="CancelChanges"><i class="fas fa-times mr-1"></i>Cancel Changes</button>
                }
            }
        </div>
    </div>
}

@if (Locked == true)
{
    <div class="row">
        <div class="col-md-12">
            @if(_appState.AuthorizedFolders.FirstOrDefault(f => f.Id == _appState.CurrentFolderId)?.Write == true)
            {
                <label class="btn btn-info mt-1">
                    <InputFile OnChange="UploadFile" style="display:none;" placeholder="Select &amp Upload File" /> Attach File (32mb size limit)
                </label>
            }
        </div>
    </div>

    @if(customer.Files.Count > 0)
    {
        <div class="row">
            <div class="col-md-12">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th width="200" style="min-width: 200px; width: 200px"></th>
                                <th width="200" style="min-width: 200px; width: 200px">Uploaded</th>
                                <th>Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var file in customer.Files.OrderByDescending(f => f.Uploaded))
                            {
                                <tr>
                                    <td>
                                        <div class="btn btn-primary" @onclick="() => ViewFile(file)"><i class="fas fa-download"></i></div>
                                        @if (_appState.AuthorizedFolders.FirstOrDefault(f => f.Id == _appState.CurrentFolderId)?.Write == true)
                                        {
                                            <div class="btn btn-danger ml-1" @onclick="() => DeleteFile(file)"><i class="far fa-trash-alt"></i></div>
                                        }
                                    </td>
                                    <td>@file.Uploaded.ToLocalTime()</td>
                                    <td>@file.Name</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
}


@code {

    [Parameter]
    public string FolderId { get; set; }

    [Parameter]
    public string Id { get; set; }

    private ghostlight.Shared.Customer customer = new ghostlight.Shared.Customer();
    private bool Locked { get; set; }

    //Used to track form changes. Not used until a "LocationChanging" event is included in framework.
    private int ChangeHash { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        if (Id != null)
        {
            Locked = true;
            customer = await API.CustomerGetById(FolderId, Id);
            ChangeHash = customer.GetHashCode();
        }
        else
        {
            Locked = false;
        }
    }

    private void ToggleEditing()
    {
        Locked = false;
    }

    async private Task Save()
    {
        if (string.IsNullOrEmpty(Id))
        {
            var response = await API.CustomerCreate(FolderId, customer);
            if (response != null)
                _navigationManager.NavigateTo($"folder/{FolderId}/customer/{response.Id}");
        }
        else if (!string.IsNullOrEmpty(Id))
        {
            var response = await API.CustomerUpdateById(customer, FolderId, Id);
            if (response != null)
            {
                customer = response;
                Locked = true;
            }
        }
        ChangeHash = customer.GetHashCode();
    }

    async private Task Delete()
    {
        var modal = _modalService.Show<ConfirmDialog>("Are you sure you want to delete this customer?");
        var modalResult = await modal.Result;

        if (modalResult.Cancelled) { }
        else
        {
            await API.CustomerDeleteById(FolderId, Id);
            _navigationManager.NavigateTo($"folder/{FolderId}/customers");
        }
    }

    async private Task CancelChanges()
    {
        Locked = true;
        customer = await API.CustomerGetById(FolderId, Id);
        ChangeHash = customer.GetHashCode();
    }

    //Reading image bytes in browser may not be optimal in all situations. Adjust as needed.
    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        var format = e.File.ContentType;
        long maxAllowedSize = 33_554_432;

        if (e.File.Size > maxAllowedSize)
        {
            _toastService.ShowError("Selected file is to big. Please choose file less than 32mb");
            return;
        }

        //If gif images will be uploaded, do not do this call - it will remove the animation
        var resizedImageFile = await e.File.RequestImageFileAsync(format, 500, 500);

        var buffer = new byte[resizedImageFile.Size];
        await resizedImageFile.OpenReadStream(maxAllowedSize).ReadAsync(buffer);
        var imageDataUrl = $"data:{format};base64,{Convert.ToBase64String(buffer)}";

        customer.ImageBase64 = imageDataUrl;
    }

    private void RemoveFile()
    {
        customer.ImageBase64 = null;
    }
    async private Task UploadFile(InputFileChangeEventArgs e)
    {
        _spinnerService.Show();

        var format = e.File.ContentType;
        long maxAllowedSize = 33_554_432;

        if (e.File.Size > maxAllowedSize)
        {
            _toastService.ShowError("Selected file is to big. Please choose file less than 32mb");
            return;
        }

        var buffer = new byte[e.File.Size];
        await e.File.OpenReadStream(maxAllowedSize).ReadAsync(buffer);
        //var fileDataBas64 = $"data:{format};base64,{Convert.ToBase64String(buffer)}";

        ghostlight.Shared.UploadFile uploadFile = new ghostlight.Shared.UploadFile()
        {
            Data = buffer,
            FileName = e.File.Name,
            MimeType = format
        };

        await API.UploadFile(uploadFile, FolderId, Id);
        customer = await API.CustomerGetById(FolderId, Id);
    }

    async private Task ViewFile(ghostlight.Shared.CustomerFile file)
    {
        var download = await API.DownloadFileByCompanyIdFileId(Id, FolderId, file.Id);
        var fileDataBas64 = $"data:;base64,{Convert.ToBase64String(download.Data)}";

        await JSRuntime.InvokeAsync<object>(
            "FileSaveAs",
            download.FileName,
            fileDataBas64
        );

        _toastService.ShowSuccess("File Downloaded");
    }

    async private Task DeleteFile(ghostlight.Shared.CustomerFile file)
    {
        var modal = _modalService.Show<ConfirmDialog>("Are you sure you want to delete this file?");
        var modalResult = await modal.Result;

        if (modalResult.Cancelled) { }
        else
        {
            await API.DeleteFileByCompanyIdFileId(Id, FolderId, file.Id);
            customer = await API.CustomerGetById(FolderId, Id);
        }
    }

    ///////Leave this block commented out, until navigation manager exposes a "LocationChanging" event.
    //protected override void OnInitialized()
    //{
    //    _navigationManager.LocationChanged += HandleLocationChanged;
    //}

    //private void HandleLocationChanged(object sender, LocationChangedEventArgs e)
    //{
    //    int currentChangeHash = customer.GetHashCode();

    //    if (ChangeHash != currentChangeHash)
    //    {
    //        var modal = _modalService.Show<ConfirmDialog>("There are unsaved changes. Save and Continue?");
    //        var modalResult = modal.Result.Result;

    //        if (modalResult.Cancelled) { }
    //        else
    //        {
    //            if (string.IsNullOrEmpty(Id))
    //                API.CustomerCreate(customer).Wait();
    //            else if (!string.IsNullOrEmpty(Id))
    //                API.CustomerUpdateById(customer, Id).Wait();
    //            _navigationManager.NavigateTo(e.Location);
    //        }
    //    }
    //}

    //public void Dispose()
    //{
    //    _navigationManager.LocationChanged -= HandleLocationChanged;
    //}

}